name: Android Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "Semantic version name (e.g. 1.2.0)"
        required: true
      version_code:
        description: "Monotonic version code (e.g. 5)"
        required: true
      create_tag:
        description: "Create Git tag v<version_name>"
        required: false
        default: true
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

env:
  JAVA_VERSION: "17"
  ANDROID_API_LEVEL: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  SIGNING_KEYSTORE_PATH: "app/signing/release.keystore"

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}
          target: android-${{ env.ANDROID_API_LEVEL }}
          cache: true

      - name: Determine version metadata
        id: version
        run: |
          VERSION_NAME_INPUT="${{ github.event.inputs.version_name }}"
          VERSION_CODE_INPUT="${{ github.event.inputs.version_code }}"

          if [ -n "$VERSION_NAME_INPUT" ]; then
            VERSION_NAME="$VERSION_NAME_INPUT"
          else
            VERSION_NAME="${GITHUB_REF_NAME#v}"
          fi

          if [ -z "$VERSION_NAME" ]; then
            VERSION_NAME="$(grep -E '^APP_VERSION_NAME=' gradle.properties | cut -d'=' -f2)"
          fi

          if [ -n "$VERSION_CODE_INPUT" ]; then
            VERSION_CODE="$VERSION_CODE_INPUT"
          else
            VERSION_CODE="$(grep -E '^APP_VERSION_CODE=' gradle.properties | cut -d'=' -f2)"
          fi

          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ]; then
            echo "Unable to determine version metadata." >&2
            exit 1
          fi

          echo "version_name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "version_tag=v$VERSION_NAME" >> "$GITHUB_OUTPUT"

      - name: Prepare signing keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p "$(dirname "${SIGNING_KEYSTORE_PATH}")"
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "${SIGNING_KEYSTORE_PATH}"
          echo "ANDROID_KEYSTORE_PATH=${GITHUB_WORKSPACE}/${SIGNING_KEYSTORE_PATH}" >> "$GITHUB_ENV"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Assemble release artifacts
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
        run: |
          ./gradlew --stacktrace --no-daemon \
            -PversionName="$VERSION_NAME" \
            -PversionCode="$VERSION_CODE" \
            -Pandroid.injected.signing.store.file="$ANDROID_KEYSTORE_PATH" \
            -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD" \
            assembleRelease bundleRelease

      - name: Upload release bundle
        uses: actions/upload-artifact@v5
        with:
          name: release-bundle
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab

      - name: Create Git tag
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true'
        uses: actions/github-script@v8
        env:
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        with:
          script: |
            const tag = process.env.VERSION_TAG;
            if (!tag) {
              core.setFailed('VERSION_TAG was not provided');
              return;
            }

            const { repo, owner } = context.repo;
            const sha = context.sha;

            try {
              await github.rest.git.createRef({ owner, repo, ref: `refs/tags/${tag}`, sha });
            } catch (error) {
              if (error.status === 422) {
                core.notice(`Tag ${tag} already exists; skipping creation.`);
                return;
              }

              core.setFailed(`Unable to create tag ${tag}: ${error.message}`);
            }

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true')
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.version_tag }}
          tag_name: ${{ steps.version.outputs.version_tag }}
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
